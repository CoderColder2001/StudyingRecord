[TOC]
# Content
- 应用层
- 传输层
- 网络层

------
## 应用层
如 HTTP、FTP、Telnet、DNS、SMTP等  
只需要专注于 <b>为用户提供应用功能</b>，不用去关心数据是如何传输的  
应用层工作在操作系统中的用户态  

URL 对应于“请求某一服务器的某一资源”  
浏览器解析 URL 并生成 HTTP 消息后，委托操作系统将消息发送给 Web 服务器  

DNS服务器保存 Web 服务器域名与 IP 的对应关系  

<br>

---
### HTTP
超文本传输协议 HyperText Transfer Protocol  

HTTP/1.1：
- 持久链接（相较1.0）：可以实现管道传输（可在同一个 TCP 连接里面，客户端可以发起多个请求，不用等待响应后再发送）；但服务器是按请求的顺序响应的，服务器响应慢时会导致客户端一直请求不到数据（队头阻塞）
- 只能压缩`body`部分，首部信息越多延迟越大，且每次互相发送相同的首部造成的浪费较多
- 无状态：服务器不会去记忆 HTTP 的状态    
- 没有请求优先级控制
- 请求只能从客户端开始，服务器只能被动响应

Cookie：通过 在请求和响应报文中写入 Cookie 信息 来**控制客户端的状态**  

HTTP为明文传输：不安全，且无法验证身份  
HTTPS：在 HTTP 与 TCP 层之间加入了 SSL/TLS 协议，实现了信息加密和校验机制、身份证书  

缓存：客户端把第一次请求以及响应的数据保存在本地磁盘上，其中将请求的 URL 作为 key，而响应作为 value，形成<b>映射关系</b>，并设置一个<b>过期时间</b>；过期后发送头部带有资源摘要的请求  

HTTP/2：  
- 基于HTTPS；先进行TCP握手，再进行TLS握手
- 头部压缩：在客户端和服务器同时维护一张头信息表，所有字段都会存入这个表，生成一个索引号；不发送同样字段，只发送索引号
- 报文采用二进制格式，以frame为最小单位（分为 headers frame 和 data frame）
- 并发传输：多个 Stream 复用在一条 TCP 连接
- 服务器推送：服务器可以主动发送消息
- 基于TCP，由于“TCP 层必须保证收到的字节数据是完整且连续的，内核才会将缓冲区里的数据返回给 HTTP 应用”，还是可能发生队头阻塞

HTTP/3:  
- 基于UDP，解决队头阻塞问题
- 采用基于 UDP 的 QUIC 协议，实现类似 TCP 的可靠传输（QUIC上的多个流之间没有相互依赖，当某个流发生丢包时，只会阻塞这个流，其他流不会受到影响，因此不存在队头阻塞问题）
- QUIC握手只需要 1 RTT（用于确认双方的「连接 ID」）（QUIC 内部包含了 TLS，它在自己的帧会携带 TLS 里的“记录”）
- 在第二次连接的时候，应用数据包可以和 QUIC 握手信息（连接信息 + TLS 信息）一起发送，达到 0 RTT
- 更低的连接迁移成本（只通过连接 ID 来标记通信的两个端点）

<br>

如何减少HTTP请求次数？  
- 减少（资源迁移引起的）重定向请求次数：重定向的工作交由代理服务器完成
- 合并请求：把多个访问小文件的请求合并成一个大的请求
- 延迟发送请求：只获取当前用户所看到的页面资源

<br>

------
## 传输层
接收方凭借传输层的报文中携带的端口号识别出该报文是发送给哪个应用   

### TCP & UDP
TCP的机制背后是<b>通过一个个数据结构来实现的逻辑</b>。而为了实现这套逻辑，操作系统内核需要在两端代码里维护一套复杂的<b>状态机</b>（三次握手，四次挥手，RST，closing等异常处理机制），<b>这套状态机其实就是所谓的"连接"</b>。 &emsp; 而UDP不需要状态机   
（实现 流量控制、超时重传、拥塞控制等 特性）  

一条 TCP 连接通过四元组（源 IP、源端口、目的 IP、目的端口）确定  

UDP本质是 内核提供的一个最小网络传输功能（在应用层添加可靠性保障）  

在传一个大的数据包时，TCP内部根据MSS的大小分段，丢包只需重传MSS分片；而UDP本身并不会分段，数据过大时，到了IP层进行分片，丢包需要重传整个数据包。  

<br>

---
### TCP三次握手与四次挥手
三次握手：  
1 客户端请求连接、2 服务端回复同意、3 客户端回复收到同意并开始正式发送数据  
*防止已经失效的连接请求报文突然又传送到了服务器*  
（若两次握手可能导致 因超时而重复发送的1带来了多次的连接）  

四次挥手：  
1 客户端“我发完了”、2 服务端回复收到（此时服务端可能仍有数据未发送）、3 服务端“我发完了”、4 客户端回复收到   

<br>

------
## 网络层
寻路、路由；负责将数据从一个设备传输到另一个设备（路径和节点选择）  

### IP协议
将传输层的报文作为数据部分，再加上 IP 包头组装成 IP 报文   

IP 地址分成两种意义：（通过子网掩码）
- 网络号：负责标识该 IP 地址是属于哪个「子网」的；
- 主机号：负责标识同一「子网」下的不同主机；